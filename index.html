<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISCartuchos - O.S. Grid Invertido</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        :root { --bg-desktop: #2c3e50; --win-bg: #e0e0e0; --win-header: linear-gradient(to right, #000080, #1084d0); --input-border: #7f9db9; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 11px; background: var(--bg-desktop); overflow: hidden; height: 100vh; display: flex; flex-direction: column; user-select: none; }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; }
        ::-webkit-scrollbar-thumb { background: #cdcdcd; border: 1px solid #fff; }

        /* --- MEN√ö Y TOOLBAR --- */
        .top-menu { background: #f0f0f0; padding: 2px 10px; border-bottom: 1px solid #d0d0d0; display: flex; gap: 15px; color: #000; }
        .menu-item { cursor: pointer; } .menu-item:hover { background-color: #316ac5; color: white; }
        
        .toolbar { background: #ffffff; border-bottom: 1px solid #888; padding: 5px 10px; display: flex; align-items: center; height: 65px; flex-shrink: 0; gap: 10px; }
        
        .tools-left { display: flex; align-items: center; gap: 2px; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 75px; height: 60px; border: 1px solid transparent; cursor: pointer; border-radius: 3px; color: #000; }
        .tool-btn:hover { border: 1px solid #aaa; background: #e0e0e0; box-shadow: inset 0 0 3px white; }
        .tool-icon { font-size: 32px; margin-bottom: 3px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2)); }
        .tool-text { font-size: 10px; font-weight: bold; color: #333; font-family: Tahoma, sans-serif; }
        .separator { width: 1px; height: 40px; background: #ccc; margin: 0 5px; border-right: 1px solid #fff; }
        
        .search-container { border: 1px solid #ccc; border-radius: 4px; padding: 3px; background: #f9f9f9; display: flex; flex-direction: column; align-items: flex-start; margin-left: 10px; }
        .search-label { font-size: 10px; color: #333; margin-bottom: 2px; margin-left: 2px; }
        .search-box { display: flex; gap: 0; }
        
        .search-input { width: 100px; border: 1px solid #7f9db9; font-size: 12px; padding: 2px; outline: none; height: 8mm; }
        .search-btn { border: 1px solid #7f9db9; border-left: none; background: #e0e0e0; cursor: pointer; font-weight: bold; width: 25px; height: 8mm; } .search-btn:active { background: #ccc; }

        /* --- VENTANAS --- */
        .window { position: absolute; background: var(--win-bg); border: 2px solid #fff; border-right-color: #444; border-bottom-color: #444; box-shadow: 10px 10px 30px rgba(0,0,0,0.5); display: none; flex-direction: column; width: 700px; max-height: 95vh; touch-action: none; border-radius: 4px; outline: 1px solid #000080; }
        .title-bar { background: var(--win-header); color: white; padding: 6px 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: move; font-size: 13px; height: 25px; border-bottom: 1px solid #000; }
        .btn-close { background: #c0392b; color: white; width: 20px; height: 18px; border-radius: 2px; line-height: 16px; text-align: center; border: 1px solid #fff; cursor: pointer; font-size: 12px; font-weight: bold; }
        .win-body { padding: 6px; flex: 1; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; background: #d4d0c8; }

        /* --- CONTROLES DE FORMULARIO --- */
        fieldset { border: 1px solid #999; padding: 5px; border-radius: 3px; margin: 0; }
        legend { font-size: 10px; color: #333; font-weight: bold; margin-bottom: 0px; }
        
        .os-row { display: flex; gap: 5px; align-items: center; }
        .os-label { font-size: 10px; color: #444; }
        .os-input { border: 1px solid #7f9db9; height: 8mm; font-size: 12px; padding: 0 4px; box-sizing: border-box; }
        .os-input[readonly] { background: #eee; color: #555; }
        .os-btn { background: #e0e0e0; border: 1px solid #7f9db9; cursor: pointer; font-size: 11px; padding: 0 8px; box-shadow: 1px 1px 1px rgba(0,0,0,0.1); height: 8mm; display:flex; align-items:center; justify-content:center; }
        .os-btn:active { transform: translateY(1px); }

        /* Tabs */
        .os-tabs { display: flex; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #999; padding-bottom: 5px; }
        .os-tab { text-align: center; padding: 3px 15px; background: #e0e0e0; border: 1px solid #7f9db9; cursor: pointer; color: #333; font-size: 11px; border-radius: 2px; box-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        .os-tab:hover { background: #f0f0f0; }
        .os-tab.active { background: #fff; border: 1px solid #000080; color: #000; font-weight: bold; }

        .tab-content { border: 1px solid #7f9db9; background: #f0f0f0; padding: 8px; flex: 1; display: none; flex-direction: column; gap: 5px; }
        .tab-content.active { display: flex; }

        /* Grillas */
        .data-grid { background: #fff; border: 1px solid #7f9db9; width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        .data-grid th { background: #e0e0e0; border-bottom: 1px solid #999; padding: 2px; text-align: left; font-weight: normal; border-right: 1px solid #ccc; white-space: nowrap; overflow: hidden; }
        .data-grid td { padding: 2px; border-bottom: 1px solid #eee; border-right: 1px solid #eee; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .data-grid tr:hover { background: #ffffcc; }
        
        .data-grid tr.selected-row { background-color: #000080; color: white; }
        .data-grid tr.selected-row td { color: white; border-right: 1px solid #999; }

        .grid-wrapper { border: 1px solid #999; background: #fff; overflow-y: auto; height: 100px; }
        
        .products-wrapper {
            border: 1px solid #999; 
            background: #fff; 
            overflow-y: scroll; 
            margin-top: 5px;
            height: 125px; 
            min-height: 125px; 
            max-height: 125px;
            flex: 0 0 125px; 
        }

        .list-toolbar { display: flex; gap: 5px; align-items: center; padding: 5px; background: #d4d0c8; border-bottom: 1px solid #999; }

        .client-form { display: flex; flex-direction: column; gap: 6px; }
        .frm-row { display: flex; gap: 5px; width: 100%; align-items: flex-end; }
        .frm-col { display: flex; flex-direction: column; gap: 1px; }
        .frm-input, .frm-select { border: 1px solid #7f9db9; padding: 2px 4px; font-size: 12px; height: 8mm; width: 100%; box-sizing: border-box; background: #fff; }
        .frm-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .bottom-actions { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-top: 5px; padding-top: 5px; border-top: 1px solid #ccc; }
        .big-btn-group { display: flex; gap: 5px; }
        .big-btn { display: flex; flex-direction: column; align-items: center; padding: 4px 8px; border: 1px solid #7f9db9; background: #e0e0e0; cursor: pointer; border-radius: 3px; min-width: 60px; }
        .big-btn:hover { background: #d0d0d0; }
        .frm-textarea { border: 1px solid #7f9db9; font-family: sans-serif; font-size: 11px; height: 50px; resize: none; width: 100%; box-sizing: border-box; }
        .frm-label { font-size: 10px; color: #444; }

        .chart-container { background: #fff; border: 1px solid #888; box-shadow: inset 1px 1px 3px #ccc; padding: 10px; flex: 1; min-height: 300px; position: relative;}
        .chart-controls { border: 1px solid #aaa; border-radius: 4px; padding: 5px; background: #e0e0e0; margin-top: 5px; display: flex; align-items: center; gap: 10px; }
        .chart-fieldset { border: 1px solid #999; padding: 3px 8px; border-radius: 3px; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

    <div class="top-menu">
        <span class="menu-item">Archivo</span><span class="menu-item">Registro</span><span class="menu-item">Informes</span><span class="menu-item">Herramientas</span><span class="menu-item">Ventana</span><span class="menu-item">Ayuda</span>
    </div>

    <div class="toolbar">
        <div class="tools-left">
            <div class="tool-btn" onclick="abrirVentana('winTotalizador')"><span class="tool-icon">üóÑÔ∏è</span><span class="tool-text">TOTALIZADOR</span></div>
            <div class="tool-btn" onclick="abrirVentana('winOS')"><span class="tool-icon">üìÇ</span><span class="tool-text">O.S.</span></div>
            <div class="separator"></div>
            <div class="tool-btn" onclick="abrirVentana('winClientes')"><span class="tool-icon">üë§</span><span class="tool-text">CLIENTES</span></div>
            <div class="tool-btn" onclick="abrirVentana('winProductos')"><span class="tool-icon">‚óºÔ∏è</span><span class="tool-text">PRODUCTOS</span></div>
            <div class="tool-btn" onclick="abrirVentana('winGraficos')"><span class="tool-icon">üìä</span><span class="tool-text">GR√ÅFICOS</span></div>
            <div class="separator"></div>
            <div class="tool-btn" onclick="alert('Ayuda')"><span class="tool-icon">‚ùì</span><span class="tool-text">AYUDA</span></div>
            <div class="separator"></div>
            <div class="tool-btn" onclick="alert('Backup')"><span class="tool-icon">üíæ</span><span class="tool-text">BACKUP</span></div>
            <div class="tool-btn" onclick="alert('Opciones')"><span class="tool-icon">üõ†Ô∏è</span><span class="tool-text">OPCIONES</span></div>
            <div class="tool-btn" onclick="salirDelSistema()"><span class="tool-icon" style="color:red;">üî¥</span><span class="tool-text">SALIR</span></div>
            
            <div class="search-container">
                <span class="search-label">Buscar Serie</span>
                <div class="search-box">
                    <input type="text" class="search-input">
                    <button class="search-btn">></button>
                </div>
            </div>
        </div>
    </div>

    <div style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:rgba(255,255,255,0.1); z-index: -1;">
        <h1 style="font-size: 100px; margin:0;">SIS</h1>
    </div>

    <div id="winOS" class="window" style="top:40px; left:40px; width: 780px; height: 600px;">
        <div class="title-bar"><span>Orden de Servicio</span><span class="btn-close" onclick="cerrarVentana('winOS')">‚úï</span></div>
        <div class="win-body">
            
            <div style="border:1px solid #7f9db9; background:#fff; height: 130px; overflow-y:scroll; margin-bottom: 5px;">
                <table class="data-grid">
                    <thead>
                        <tr>
                            <th style="width: 50px;">C√≥digo</th>
                            <th style="width: 200px;">Nombre</th>
                            <th>Direcci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="gridClientesOS">
                        </tbody>
                </table>
            </div>

            <fieldset style="background: #fff; margin-bottom: 5px; padding-bottom: 8px;">
                <legend>Cliente</legend>
                <div class="os-row" style="margin-bottom: 2px;">
                    <div style="width: 80px; font-size:10px;">C√≥digo</div>
                    <div style="flex:1; font-size:10px;">Nombre del Cliente (Escriba para buscar)</div>
                </div>
                <div class="os-row">
                    <input type="text" id="osCliCodigo" class="os-input" style="width: 80px; text-align:center; font-weight:bold;" readonly placeholder="Cod">
                    
                    <input type="text" id="osCliNombre" class="os-input" style="flex:1; font-weight:bold;" 
                           placeholder="Escriba aqu√≠ para buscar en la lista de arriba..." 
                           onkeyup="filtrarClientesOS()">
                </div>
            </fieldset>

            <div class="os-tabs">
                <div class="os-tab active" onclick="cambiarTabOS('abrir')" id="tabAbrir">Abrir O.S.</div>
                <div class="os-tab" onclick="cambiarTabOS('leer')" id="tabLeer">Razones / Leer</div>
                <div class="os-tab" onclick="alert('Confirmar Pago')">Pagos</div>
            </div>

            <div id="contentAbrir" class="tab-content active">
                <div style="display: flex; gap: 10px; height: 100%;">
                    <div style="flex: 1.2; display: flex; flex-direction: column; gap: 5px;">
                        <fieldset style="flex:1; display:flex; flex-direction:column; gap:4px;">
                            <legend>Inserte Productos</legend>
                            <label class="os-label">Descripci√≥n</label>
                            <select id="osProdDesc" class="os-input" style="width:100%;">
                                <option value="Recarga de Cartucho">Recarga de Cartucho</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                            <label class="os-label">Producto</label>
                            <select id="osProdItem" class="os-input" style="width:100%;" onchange="actualizarPrecioOS()">
                                <option value="">- Seleccione -</option>
                            </select>
                            
                            <div class="os-row" style="align-items: flex-end;">
                                <div style="width: 40px;">
                                    <label class="os-label">CTD</label>
                                    <input type="number" id="osCtd" class="os-input" value="1" style="width: 100%;">
                                </div>
                                <div style="flex: 1;">
                                    <label class="os-label">Chasis / Serie</label>
                                    <input type="text" id="osSerie" class="os-input" style="width: 100%;">
                                </div>
                                <div style="width: 70px;">
                                    <label class="os-label">Valor ($)</label>
                                    <input type="text" id="osValor" class="os-input" style="width: 100%;">
                                </div>
                                <button class="os-btn" style="width: 30px; font-weight:bold; height: 8mm;" onclick="agregarProductoOS()" title="Agregar">+</button>
                                <button class="os-btn" style="height: 8mm;" onclick="limpiarInputsProducto()">Limpio</button>
                            </div>

                            <div id="wrapperProductos" class="products-wrapper">
                                <table class="data-grid">
                                    <thead><tr><th style="width:20px;">Art√≠c</th><th>Descripci√≥n</th><th>Serie</th></tr></thead>
                                    <tbody id="gridProductosAgregados"></tbody>
                                </table>
                            </div>
                        </fieldset>
                    </div>
                    
                    <div style="flex: 0.8; display: flex; flex-direction: column; gap: 5px; height: 100%;">
                        
                        <div style="flex: 1; display:flex; flex-direction:column; gap:2px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label class="os-label">Observaciones:</label>
                                <div style="display: flex; align-items: center; gap: 5px; background: #ddd; padding: 0 5px; border-radius: 3px; border:1px solid #aaa;">
                                    <input type="checkbox" id="chkEntregar" style="margin: 3px 0;"> 
                                    <label for="chkEntregar" class="os-label" style="font-weight: bold; cursor: pointer;">Entregar</label>
                                </div>
                            </div>
                            <textarea id="osObs" class="os-input" style="flex: 1; width: 100%; resize:none; height:auto; font-family: sans-serif;"></textarea>
                        </div>

                        <div style="margin-top: 5px;">
                            <label class="os-label">Previsi√≥n de entrega</label>
                            
                            <div class="os-row" style="align-items: flex-end;">
                                <input type="date" id="osFechaEntrega" class="os-input" style="width: 100px;">
                                <input type="text" class="os-input" style="flex:1;">
                                
                                <div style="display: flex; flex-direction: column; align-items: center; margin-left: 5px; gap: 0;">
                                    <span class="os-label" style="margin-bottom: 2px;">V√≠as</span>
                                    <input type="text" class="os-input" value="1" style="width: 40px; text-align:center;">
                                </div>
                            </div>
                            
                            <button class="os-btn" style="width:100%; height: 40px; margin-top: 10px; font-weight:bold;" onclick="generarOS()">ABRIR</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="contentLeer" class="tab-content">
                <div class="list-toolbar">
                    <select class="os-input" style="width:150px;"><option>TODOS LOS CLIENTES</option></select>
                    <label><input type="radio" name="filtroOS" checked> Abiertas</label>
                    <label><input type="radio" name="filtroOS"> Cerradas</label>
                    <button class="os-btn">Buscar</button><button class="os-btn">Cesar</button><button class="os-btn">Cerrar todo</button>
                </div>
                <div class="grid-wrapper" style="height: 150px;">
                    <table class="data-grid">
                        <thead><tr><th>O.S. Num</th><th>Descripci√≥n</th><th>Estado</th></tr></thead>
                        <tbody id="listaOSGlobal"></tbody>
                    </table>
                </div>
                <div class="grid-wrapper" style="flex:1;">
                    <table class="data-grid">
                        <thead><tr><th>Art√≠culo</th><th>Descripci√≥n</th><th>Producto</th><th>Serie</th><th>Valor Un.</th><th>CTD</th><th>Subtotal</th></tr></thead>
                        <tbody id="detalleOSSeleccionada"></tbody>
                    </table>
                </div>
                <div class="os-row" style="justify-content:space-between; align-items:flex-end;">
                    <div style="background:#000; color:#0f0; padding:5px; font-family:monospace; width:120px;">DEAL: $120.00<br>RESTA: 00.00</div>
                    <div style="display:flex; gap:5px;">
                        <button class="os-btn" style="height:30px; width:80px;" onclick="if(osSeleccionada) imprimirTicket(osSeleccionada); else alert('Seleccione una OS primero');">Imprimir</button>
                        <button class="os-btn" style="height:30px; width:80px;">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="winClientes" class="window" style="top:90px; left:50px;">
        <div class="title-bar"><span>Registro del Cliente</span><span class="btn-close" onclick="cerrarVentana('winClientes')">‚úï</span></div>
        <div class="win-body" style="background: #e4e4e4;">
            <div class="client-form">
                
                <div class="frm-header">
                    <span style="font-size:12px; font-weight:bold;">Datos del Cliente</span>
                    <div class="frm-radios">
                        <label style="cursor:pointer;"><input type="radio" name="modo" value="nuevo" checked onchange="cambiarModo('nuevo')"> Nuevo Registro</label>
                        <label style="cursor:pointer;"><input type="radio" name="modo" value="cambiar" onchange="cambiarModo('cambiar')"> Cambiar</label>
                    </div>
                </div>

                <div class="frm-row">
                    <div class="frm-col" style="width: 80px;"><span class="frm-label">C√≥digo</span><input type="text" id="cliCodigo" class="frm-input" value="AUTO" disabled></div>
                    <div class="frm-col" style="width: 90%;"><span class="frm-label">Nombre del Cliente</span><div style="display: flex; gap: 5px;"><input type="text" id="cliNombre" class="frm-input" style="flex: 1.5;" placeholder="Nombre del cliente..."><input type="text" id="cliBusqueda" class="frm-input" style="flex: 1;" list="listaClientes" placeholder="üîç Buscar aqu√≠..." oninput="detectarCliente()" disabled><datalist id="listaClientes"></datalist></div></div>
                </div>
                <div class="frm-row">
                    <div class="frm-col" style="flex: 1.5;"><span class="frm-label">Direcci√≥n</span><input type="text" id="cliDireccion" class="frm-input"></div>
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Colonia</span><input type="text" id="cliColonia" class="frm-input"></div>
                </div>
                <div class="frm-row">
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Ciudad</span><input type="text" id="cliCiudad" class="frm-input"></div>
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Estado</span><input type="text" id="cliEstado" class="frm-input"></div>
                    <div class="frm-col" style="flex: 1.5;"><span class="frm-label">Nombre del Contacto</span><input type="text" id="cliContacto" class="frm-input"></div>
                </div>
                <div class="frm-row" style="margin-top: 5px; border: 1px dotted #999; padding: 3px;">
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Tel√©fono 1</span><input type="text" id="cliTel1" class="frm-input"></div>
                    <div class="frm-col" style="flex: 0.5;"><span class="frm-label">C.P.</span><input type="text" id="cliCP" class="frm-input" style="text-align: center;"></div>
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Tel√©fono 2</span><input type="text" id="cliTel2" class="frm-input"></div>
                </div>
                <div class="frm-row">
                    <div class="frm-col" style="flex: 1;"><span class="frm-label">Correo Electronico</span><input type="text" id="cliEmail" class="frm-input"></div>
                </div>
                <div class="frm-col"><span class="frm-label">Observaciones</span><textarea id="cliObs" class="frm-textarea"></textarea></div>
                
                <div class="bottom-actions">
                    <div class="frm-col" style="margin-right: auto;"><span class="frm-label">Fecha de registro</span><input type="date" class="frm-input" value="2025-01-27" style="width: 120px;"></div>
                    <div class="big-btn-group">
                        <button class="big-btn" onclick="alert('Datos Guardados')"><span class="icon">üíæ</span><span style="font-size:10px;">Guardar</span></button>
                        <button class="big-btn" onclick="alert('Registro Eliminado')"><span class="icon">üóëÔ∏è</span><span style="font-size:10px;">Eliminar</span></button>
                        <button class="big-btn" onclick="limpiarFormulario()"><span class="icon">üßπ</span><span style="font-size:10px;">Borrar</span></button>
                        <button class="big-btn" onclick="cerrarVentana('winClientes')"><span class="icon" style="color:red;">‚≠ï</span><span style="font-size:10px;">Cancelar</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="winGraficos" class="window" style="top:60px; left:60px; width: 750px; height: 500px;"><div class="title-bar"><span>Gr√°fico de Unidad Financiera</span><span class="btn-close" onclick="cerrarVentana('winGraficos')">‚úï</span></div><div class="win-body"><div style="text-align:center; margin-bottom: 5px; font-weight:bold; font-size:14px; font-family:'Tahoma';">VENDAS Y RECARGAS √öLTIMOS 12 MESES</div><div class="chart-container"><canvas id="miGrafico"></canvas></div><div class="chart-controls"><fieldset class="chart-fieldset"><legend class="chart-legend">Opciones</legend><select id="selPeriodo" class="frm-select" style="width: 100px;"><option value="meses">Meses</option><option value="semanas">Semanas</option></select><select id="selTipoGrafico" class="frm-select" style="width: 120px;"><option value="bar">Barras 2D</option><option value="bar3d">Barras 3D (Sim)</option><option value="line">L√≠neas 2D</option><option value="line3d">L√≠neas 3D (Sim)</option></select><button class="frm-input" style="width: 80px; background: #eee; cursor:pointer; font-weight:bold;" onclick="actualizarGrafico()">Exponer</button><button class="frm-input" style="width: 80px; background: #eee; cursor:pointer;" onclick="window.print()">Imprimir</button></fieldset></div></div></div>
    <div id="winTotalizador" class="window" style="top:100px; left:100px;"><div class="title-bar"><span>üì† Caja / Totalizador</span><span class="btn-close" onclick="cerrarVentana('winTotalizador')">‚úï</span></div><div class="win-body"></div></div>
    <div id="winProductos" class="window" style="top:120px; left:140px;"><div class="title-bar"><span>üì¶ Productos</span><span class="btn-close" onclick="cerrarVentana('winProductos')">‚úï</span></div><div class="win-body"></div></div>

<script>
    const DB_CLIENTES = [
        { id: 2375, nombre: "EDIFICACIONES JUAN HERNANDEZ", direccion: "Josefa Ortiz de Dominguez #107 - San Miguel", colonia: "Centro", ciudad: "Celaya", estado: "GTO", cp: "38000", contacto: "Juan", tel1: "461-111-2222", tel2: "461-333-4444", email: "juan@mail.com", obs: "Cliente frecuente" },
        { id: 3913, nombre: "ERACLIO JUANDIEGO VAZQUEZ", direccion: "Venezuela #16 - La Luciernaga", colonia: "Alameda", ciudad: "Cortazar", estado: "GTO", cp: "38300", contacto: "Maria", tel1: "411-555-6666", tel2: "", email: "maria@mail.com", obs: "Paga en efectivo" },
        { id: 2018, nombre: "JARDINES NI√ëOS JUAN AMOS CONVENIO", direccion: "Javier Solis #100 - Imperial", colonia: "Zona Ind.", ciudad: "Celaya", estado: "GTO", cp: "38010", contacto: "Lic. Sanchez", tel1: "461-999-8888", tel2: "461-777-1111", email: "compras@empresa.com", obs: "Requiere factura" },
        { id: 5012, nombre: "DISTRIBUIDORA DEL BAJIO SA DE CV", direccion: "Av. Tecnologico #450", colonia: "Industrial", ciudad: "Celaya", estado: "GTO", cp: "38020", contacto: "Ing. Perez", tel1: "461-222-3333", tel2: "", email: "perez@bajio.com", obs: "" },
        { id: 1024, nombre: "CENTRO ESCOLAR MANUEL DOBLADO", direccion: "Madero #33 - Centro", colonia: "Centro", ciudad: "Celaya", estado: "GTO", cp: "38000", contacto: "Directora", tel1: "461-888-9999", tel2: "", email: "escolar@mail.com", obs: "" }
    ];
    const DB_PRODUCTOS = [ { codigo: "104 RCMLT-01045", desc: "104 RCMLT-01045", precio: 390.00 }, { codigo: "101 RCMLT-0101S", desc: "101 RCMLT-0101S", precio: 450.00 }, { codigo: "122 RCH561HL BK", desc: "122 RCH561HL BK", precio: 109.00 } ];
    let itemsOrden = []; 
    let ordenesGeneradas = []; 
    let osSeleccionada = null; 

    window.onload = function() {
        activarArrastre();
        cargarListaDataList(); 
        llenarComboProductos();
        cambiarModo('nuevo');
        
        document.getElementById('osFechaEntrega').valueAsDate = new Date();
    };
    
    function salirDelSistema() {
        const confirmar = confirm("¬øEst√° seguro que desea salir?");
        if(confirmar) {
            window.close();
            window.location.href = 'https://www.google.com';
        }
    }

    /* --- L√ìGICA ORDEN DE SERVICIO --- */
    function cambiarTabOS(tab) {
        document.querySelectorAll('.os-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(tab === 'abrir') { document.getElementById('tabAbrir').classList.add('active'); document.getElementById('contentAbrir').classList.add('active'); } 
        else if (tab === 'leer') { document.getElementById('tabLeer').classList.add('active'); document.getElementById('contentLeer').classList.add('active'); actualizarListaOSGlobal(); }
    }

    function filtrarClientesOS() {
        const txt = document.getElementById('osCliNombre').value.toLowerCase();
        const grid = document.getElementById('gridClientesOS');
        grid.innerHTML = '';
        
        if(txt.length === 0) return; 

        DB_CLIENTES.forEach(c => {
            if(c.nombre.toLowerCase().includes(txt) || c.id.toString().includes(txt)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.id}</td><td>${c.nombre}</td><td>${c.direccion}</td>`;
                tr.style.cursor = 'pointer';
                tr.onclick = () => seleccionarClienteOS(c, tr);
                grid.appendChild(tr);
            }
        });
    }

    function seleccionarClienteOS(cliente, rowElement) {
        document.getElementById('osCliCodigo').value = cliente.id;
        document.getElementById('osCliNombre').value = cliente.nombre;
        
        const filas = document.getElementById('gridClientesOS').getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
            filas[i].classList.remove('selected-row');
        }
        
        if(rowElement) {
            rowElement.classList.add('selected-row');
        }
    }

    function llenarComboProductos() { const sel = document.getElementById('osProdItem'); DB_PRODUCTOS.forEach(p => { sel.innerHTML += `<option value="${p.codigo}">${p.desc}</option>`; }); }
    function actualizarPrecioOS() { const cod = document.getElementById('osProdItem').value; const prod = DB_PRODUCTOS.find(p => p.codigo === cod); if(prod) { document.getElementById('osValor').value = prod.precio.toFixed(2); } }
    
    function limpiarInputsProducto() {
        document.getElementById('osProdItem').value = "";
        document.getElementById('osCtd').value = "1";
        document.getElementById('osSerie').value = "";
        document.getElementById('osValor').value = "";
        
        itemsOrden = [];
        dibujarGridProductos();
    }

    function agregarProductoOS() {
        const descTipo = document.getElementById('osProdDesc').value; const codProd = document.getElementById('osProdItem').value; const ctd = document.getElementById('osCtd').value; const serie = document.getElementById('osSerie').value; const precio = document.getElementById('osValor').value;
        if(!codProd) return alert("Seleccione un producto");
        itemsOrden.push({ tipo: descTipo, producto: codProd, serie: serie, ctd: ctd, precio: precio });
        dibujarGridProductos(); 
        
        document.getElementById('osProdItem').value = "";
        document.getElementById('osCtd').value = "1";
        document.getElementById('osSerie').value = "";
        document.getElementById('osValor').value = "";

        const wrapper = document.getElementById('wrapperProductos');
        if(wrapper) {
            wrapper.scrollTop = wrapper.scrollHeight;
        }
    }
    
    function dibujarGridProductos() { const tbody = document.getElementById('gridProductosAgregados'); tbody.innerHTML = ''; itemsOrden.forEach((item, index) => { tbody.innerHTML += `<tr><td>${index + 1}</td><td>${item.tipo} - ${item.producto}</td><td>${item.serie}</td></tr>`; }); }
    
    function generarOS() {
        if(!document.getElementById('osCliNombre').value) return alert("Seleccione un cliente primero");
        if(itemsOrden.length === 0) return alert("Agregue al menos un producto");
        
        const obs = document.getElementById('osObs').value;
        const entregaDate = document.getElementById('osFechaEntrega').value;

        const nuevaOS = { 
            num: 20500 + ordenesGeneradas.length + 1, 
            cliente: document.getElementById('osCliNombre').value, 
            fecha: new Date().toLocaleDateString(), 
            items: [...itemsOrden], 
            estado: 'Abierta',
            observaciones: obs,
            entrega: entregaDate
        };
        
        ordenesGeneradas.push(nuevaOS); 
        
        imprimirTicket(nuevaOS);

        itemsOrden = []; dibujarGridProductos(); document.getElementById('osCliCodigo').value = ""; document.getElementById('osCliNombre').value = ""; document.getElementById('osObs').value = "";
        cambiarTabOS('leer');
    }

    // --- FUNCI√ìN DE IMPRESI√ìN CON DOBLE COPIA (MEDIA CUARTILLA) ---
    function imprimirTicket(os) {
        const clientData = DB_CLIENTES.find(c => c.nombre === os.cliente) || { direccion: '', tel1: '', email: '' };

        let itemsHtml = '';
        let total = 0;

        os.items.forEach((item, index) => {
            const subtotal = parseFloat(item.precio) * parseInt(item.ctd);
            total += subtotal;
            let desc = `${item.tipo} - ${item.producto}`;
            if(item.serie) desc += ` (${item.serie})`;

            itemsHtml += `
            <tr>
                <td style="text-align:center;">${index + 1}</td>
                <td>${desc}</td>
                <td style="text-align:right;">${parseFloat(item.precio).toFixed(2)}</td>
                <td style="text-align:center;">${item.ctd}</td>
                <td style="text-align:right;">${subtotal.toFixed(2)}</td>
            </tr>`;
        });

        // PLANTILLA UNICA DE TICKET
        const ticketTemplate = `
            <div class="ticket-half">
                <div class="header-top">APERTURA DE LA ORDEN DE SERVICIO</div>
                <div class="main-title">SISCOBAJIO CORTAZAR TONER Y TINTAS</div>
                
                <div class="header-container">
                    <div class="logo-box"><div class="logo-text">SISCOBAJIO</div></div>
                    <div class="info-box">
                        <div style="border-bottom: 1px solid #ccc; padding-bottom: 3px; margin-bottom: 3px;">
                            Dir.: Guillermo Prieto No.405-1 &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Tel.: 411.155.0596
                        </div>
                        <div class="info-row">
                            <div style="font-weight:bold;">Cliente: ${os.cliente}</div>
                            <div>Dir.: ${clientData.direccion || ''}</div>
                        </div>
                        <div class="info-row">
                            <div>Email: ${clientData.email || ''}</div>
                            <div>Fecha: ${os.fecha} &nbsp;&nbsp; Retirar: ${os.entrega}</div>
                            <div style="font-weight:bold;">O.S.: ${os.num}</div>
                        </div>
                        <div class="info-row">
                            <div></div>
                            <div>Tel.: ${clientData.tel1 || ''}</div>
                        </div>
                    </div>
                </div>

                <div style="flex: 1;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px; text-align:center;">ART.</th>
                                <th>DESCRIPCI√ìN</th>
                                <th style="width: 80px; text-align:right;">VALOR UN.</th>
                                <th style="width: 40px; text-align:center;">X CTD</th>
                                <th style="width: 80px; text-align:right;">SUBTOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                </div>

                <div>
                    <div class="total-box">TOTAL * &nbsp;&nbsp; $ ${total.toFixed(2)}</div>

                    <div class="obs-container">
                        <strong>Observaciones:</strong> ${os.observaciones || 'NINGUNA'}
                    </div>

                    <div class="footer-disclaimer">Declaro estar al tanto de la informaci√≥n</div>
                    <div class="footer-sign">Firma del Cliente</div>
                </div>
            </div>
        `;

        const printWin = window.open('', '', 'width=800,height=900');
        printWin.document.write(`
            <html>
            <head>
                <title>O.S. #${os.num}</title>
                <style>
                    body { font-family: 'Arial', sans-serif; font-size: 11px; margin: 0; padding: 0; box-sizing: border-box; height: 100vh; overflow: hidden; }
                    
                    @media print {
                        @page { size: letter; margin: 0.5cm; }
                        body { margin: 0; }
                    }

                    /* Contenedor de media cuartilla (aprox 48% para dar espacio al corte) */
                    .ticket-half {
                        height: 48vh;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 10px;
                        box-sizing: border-box;
                        border: 1px dotted #eee; /* Gu√≠a visual sutil */
                    }

                    .cut-line {
                        height: 2vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #666;
                        font-size: 10px;
                        overflow: hidden;
                    }
                    .cut-dashed {
                        width: 100%;
                        border-top: 1px dashed #666;
                        margin: 0 10px;
                    }

                    .header-top { text-align: center; color: #666; font-size: 9px; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
                    .main-title { text-align: center; font-size: 14px; font-weight: bold; color: #333; margin: 2px 0 10px 0; }
                    
                    .header-container { display: flex; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 5px; }
                    
                    .logo-box {
                        width: 80px; height: 60px; 
                        border: 1px solid #999; border-radius: 6px; 
                        display: flex; align-items: center; justify-content: center;
                        margin-right: 15px; flex-shrink: 0;
                    }
                    .logo-text { transform: rotate(-90deg); font-weight: bold; color: #aaa; font-size: 12px; }
                    
                    .info-box { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 2px; font-size: 10px; }
                    .info-row { display: flex; justify-content: space-between; }
                    
                    table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                    th { border: 1px solid #000; background: #eee; padding: 3px; font-size: 9px; font-weight: bold; text-align: left; }
                    td { border: 1px solid #000; padding: 3px; font-size: 10px; vertical-align: middle; }
                    
                    .total-box { text-align: right; font-weight: bold; font-size: 12px; margin-top: 5px; padding-right: 5px; }
                    .obs-container { margin-top: 5px; font-size: 10px; font-style: italic; border: 1px dotted #ccc; padding: 3px; }
                    
                    .footer-disclaimer { margin-top: 15px; text-align: right; font-size: 9px; color: #444; margin-bottom: 15px; }
                    .footer-sign { border-top: 1px solid #000; width: 200px; text-align: center; margin-left: auto; padding-top: 2px; font-weight: bold; font-size: 10px; }
                </style>
            </head>
            <body>
                ${ticketTemplate}

                <div class="cut-line">
                    <div class="cut-dashed"></div>
                    <span>‚úÇ CORTAR AQU√ç</span>
                    <div class="cut-dashed"></div>
                </div>

                ${ticketTemplate}
            </body>
            </html>
        `);
        
        printWin.document.close();
        printWin.focus();
        setTimeout(() => {
            printWin.print();
            printWin.close();
        }, 500);
    }

    function actualizarListaOSGlobal() {
        const tbody = document.getElementById('listaOSGlobal'); tbody.innerHTML = '';
        if(ordenesGeneradas.length === 0) { tbody.innerHTML += `<tr><td>20503</td><td>Descripci√≥n Recarga de Cartucho...</td><td>Abierta</td></tr>`; }
        ordenesGeneradas.forEach(os => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td>${os.num}</td><td>O.S. de ${os.cliente}</td><td>${os.estado}</td>`; 
            
            tr.onclick = () => {
                verDetalleOS(os);
                Array.from(tbody.children).forEach(row => row.classList.remove('selected-row'));
                tr.classList.add('selected-row');
            }; 
            tr.style.cursor = 'pointer'; 
            tbody.appendChild(tr); 
        });
    }
    
    function verDetalleOS(os) { 
        osSeleccionada = os; 
        const tbody = document.getElementById('detalleOSSeleccionada'); 
        tbody.innerHTML = ''; 
        os.items.forEach((item, idx) => { 
            const subtotal = (item.ctd * item.precio).toFixed(2); 
            tbody.innerHTML += `<tr><td>${idx + 1}</td><td>${item.tipo}</td><td>${item.producto}</td><td>${item.serie}</td><td>${item.precio}</td><td>${item.ctd}</td><td>${subtotal}</td></tr>`; 
        }); 
    }

    /* --- GR√ÅFICOS --- */
    let chartInstance = null;
    const DATA_MESES = { labels: ['Ene','Feb','Mar','Abr'], data: [100,200,150,300] };
    const DATA_SEMANAS = { labels: ['S1','S2','S3'], data: [50,80,60] };
    function actualizarGrafico() {
        const periodo = document.getElementById('selPeriodo').value; const tipoSelect = document.getElementById('selTipoGrafico').value; let chartType = tipoSelect.includes('line') ? 'line' : 'bar'; const dataSet = (periodo === 'meses') ? DATA_MESES : DATA_SEMANAS; const ctx = document.getElementById('miGrafico').getContext('2d');
        if(chartInstance) chartInstance.destroy(); chartInstance = new Chart(ctx, { type: chartType, data: { labels: dataSet.labels, datasets: [{ label: 'Ventas', data: dataSet.data, backgroundColor: 'red', borderColor: 'darkred', borderWidth: 1, fill: false, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } } });
    }

    /* --- OTROS --- */
    function cargarListaDataList() { const datalist = document.getElementById('listaClientes'); datalist.innerHTML = ''; DB_CLIENTES.forEach(c => { const option = document.createElement('option'); option.value = c.nombre; datalist.appendChild(option); }); }
    function cambiarModo(modo) { const txtBusqueda = document.getElementById('cliBusqueda'); const txtNombre = document.getElementById('cliNombre'); if(modo === 'nuevo') { limpiarFormulario(); txtBusqueda.disabled = true; txtNombre.disabled = false; txtNombre.focus(); } else if (modo === 'cambiar') { txtBusqueda.disabled = false; txtNombre.value = ""; txtBusqueda.focus(); } }
    function detectarCliente() { const valorBusqueda = document.getElementById('cliBusqueda').value; const c = DB_CLIENTES.find(c => c.nombre === valorBusqueda); if(c) { document.getElementById('cliNombre').value = c.nombre; document.getElementById('cliDireccion').value = c.direccion; document.getElementById('cliColonia').value = c.colonia; document.getElementById('cliCiudad').value = c.ciudad; document.getElementById('cliEstado').value = c.estado; document.getElementById('cliContacto').value = c.contacto; document.getElementById('cliTel1').value = c.tel1; document.getElementById('cliTel2').value = c.tel2; document.getElementById('cliCP').value = c.cp; document.getElementById('cliEmail').value = c.email; document.getElementById('cliObs').value = c.obs; } }
    function limpiarFormulario() { const inputs = document.querySelectorAll('#winClientes input[type="text"], #winClientes textarea'); inputs.forEach(input => { if(input.id !== 'cliCodigo') input.value = ""; }); }
    let zIndex = 100;
    function abrirVentana(id) { const win = document.getElementById(id); win.style.display = 'flex'; win.style.zIndex = ++zIndex; if(id === 'winGraficos') setTimeout(actualizarGrafico, 100); }
    function cerrarVentana(id) { document.getElementById(id).style.display = 'none'; }
    function activarArrastre() { document.querySelectorAll('.title-bar').forEach(bar => { const win = bar.parentElement; let isDragging = false, startX, startY, initialLeft, initialTop; const startDrag = (e) => { isDragging = true; win.style.zIndex = ++zIndex; const cX = e.touches ? e.touches[0].clientX : e.clientX; const cY = e.touches ? e.touches[0].clientY : e.clientY; startX = cX; startY = cY; const r = win.getBoundingClientRect(); initialLeft = r.left; initialTop = r.top; }; const moveDrag = (e) => { if(!isDragging) return; e.preventDefault(); const cX = e.touches ? e.touches[0].clientX : e.clientX; const cY = e.touches ? e.touches[0].clientY : e.clientY; win.style.left = (initialLeft + (cX - startX)) + 'px'; win.style.top = (initialTop + (cY - startY)) + 'px'; }; const stopDrag = () => { isDragging = false; }; bar.addEventListener('mousedown', startDrag); document.addEventListener('mousemove', moveDrag); document.addEventListener('mouseup', stopDrag); bar.addEventListener('touchstart', startDrag, {passive:false}); document.addEventListener('touchmove', moveDrag, {passive:false}); document.addEventListener('touchend', stopDrag); }); }
</script>
</body>
</html>